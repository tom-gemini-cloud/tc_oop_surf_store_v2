{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-8 text-center">Our Products</h1>

    <!-- Filter Bar -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex flex-wrap gap-4 items-center justify-center">
            <a href="/products"
               class="px-4 py-2 rounded-lg {% if not selected_family_id %}bg-surf-blue text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition-colors">
                All Categories
            </a>
            {% for family in families %}
            <a href="/products?family_id={{ family.family_id }}"
               class="px-4 py-2 rounded-lg {% if selected_family_id == family.family_id %}bg-surf-blue text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition-colors">
                {{ family.name }}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Products Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="products-grid">
        {% for product in products %}
        <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
            <!-- Product Image Placeholder -->
            <div class="h-48 bg-gradient-to-br from-surf-blue to-surf-teal flex items-center justify-center text-white text-4xl">
                {% if "Longboard" in product.name %}🏄‍♂️
                {% elif "Shortboard" in product.name %}🏄‍♀️
                {% elif "SUP" in product.name %}🏄
                {% elif "Wetsuit" in product.name %}🤽‍♂️
                {% elif "Leash" in product.name %}🔗
                {% elif "Wax" in product.name %}🟡
                {% elif "Fin" in product.name %}🔱
                {% elif "Tee" in product.name %}👕
                {% elif "Boardshorts" in product.name %}🩳
                {% else %}🏄‍♂️
                {% endif %}
            </div>

            <div class="p-4">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-lg font-semibold text-gray-900 line-clamp-2">{{ product.name }}</h3>
                    <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">{{ product.category.name }}</span>
                </div>

                <p class="text-gray-600 text-sm mb-3 line-clamp-2">{{ product.description }}</p>

                <div class="flex justify-between items-center mb-3">
                    <span class="text-2xl font-bold text-surf-blue">£{{ "%.2f"|format(product.price) }}</span>
                    <div class="text-right">
                        <div class="text-sm {% if product.stock_quantity < 5 %}text-red-500{% else %}text-green-500{% endif %}">
                            {% if product.stock_quantity < 5 %}
                                ⚠️ Low Stock
                            {% else %}
                                ✅ In Stock
                            {% endif %}
                        </div>
                        <div class="text-xs text-gray-500">{{ product.stock_quantity }} available</div>
                    </div>
                </div>

                <form hx-post="/cart/add"
                      hx-target="body"
                      hx-swap="none"
                      hx-indicator="#loading-{{ product.product_id }}"
                      class="add-to-cart-form">
                    <input type="hidden" name="product_id" value="{{ product.product_id }}">

                    <div class="flex mb-3">
                        <label class="block text-sm font-medium text-gray-700 mr-2">Qty:</label>
                        <select name="quantity" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            {% for i in range(1, min(product.stock_quantity + 1, 11)) %}
                            <option value="{{ i }}">{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit"
                            {% if product.stock_quantity == 0 %}disabled{% endif %}
                            class="w-full py-2 rounded-lg font-semibold transition-colors
                                   {% if product.stock_quantity == 0 %}
                                       bg-gray-300 text-gray-500 cursor-not-allowed
                                   {% else %}
                                       bg-surf-teal hover:bg-teal-600 text-white
                                   {% endif %}">
                        <span id="loading-{{ product.product_id }}" class="htmx-indicator">
                            <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                        {% if product.stock_quantity == 0 %}Out of Stock{% else %}Add to Basket{% endif %}
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not products %}
    <div class="text-center py-16">
        <div class="text-6xl mb-4">🏄‍♂️</div>
        <h2 class="text-2xl font-semibold text-gray-700 mb-2">No products found</h2>
        <p class="text-gray-500 mb-6">Try selecting a different category</p>
        <a href="/products" class="bg-surf-blue hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
            View All Products
        </a>
    </div>
    {% endif %}
</div>

<script>
    // Add success notification for add to cart
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.pathInfo.requestPath === '/cart/add' && event.detail.xhr.status === 200) {
            // Show success message
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = 'Product added to basket! 🛒';
            document.body.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    });
</script>
{% endblock %}